name: Deploy to AWS

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target (all, backend, frontend)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: ukrevrocom-production
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Build and push Backend Docker image
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_target != 'frontend'
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=raw,value=backend-latest
            type=raw,value=backend-${{ github.sha }}

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64

  # Build and push Frontend Docker image
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_target != 'backend'
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=raw,value=frontend-latest
            type=raw,value=frontend-${{ github.sha }}

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64
          build-args: |
            NEXT_PUBLIC_API_URL=/api

  # Deploy to EC2
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-frontend.result == 'success')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /opt/ukrevrocom

            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            # Pull latest images
            docker-compose pull

            # Restart services with zero downtime
            docker-compose up -d --remove-orphans

            # Wait for services to be healthy
            sleep 10

            # Health check
            curl -f http://localhost:8000/health || exit 1
            curl -f http://localhost:3000 || exit 1

            # Cleanup old images
            docker image prune -f

            echo "Deployment completed successfully!"

      - name: Notify on success
        if: success()
        run: echo "Deployment successful! Application is live."

      - name: Notify on failure
        if: failure()
        run: echo "Deployment failed! Please check the logs."

  # Rollback job (manual trigger)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && failure()
    needs: [deploy]
    environment: production

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /opt/ukrevrocom

            # Get previous image tags from docker history
            PREV_BACKEND=$(docker images --format "{{.Tag}}" ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }} | grep backend- | head -2 | tail -1)
            PREV_FRONTEND=$(docker images --format "{{.Tag}}" ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }} | grep frontend- | head -2 | tail -1)

            echo "Rolling back to: backend=$PREV_BACKEND, frontend=$PREV_FRONTEND"

            # Update compose file with previous tags and restart
            docker-compose down
            docker-compose up -d

            echo "Rollback completed!"
